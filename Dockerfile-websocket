# ============================================
# Stage 1: Build Laravel dependencies
# ============================================
FROM php:8.1-fpm-alpine AS build

ENV TZ=Asia/Jakarta \
    APP_ENV=production

# Install dependencies untuk build
RUN apk add --no-cache \
    git unzip icu-dev libzip-dev libpng-dev libxml2-dev \
    postgresql-dev sqlite oniguruma-dev bash && \
    docker-php-ext-install intl pdo_pgsql bcmath gd zip opcache

# Install Composer dari official image
COPY --from=composer:2 /usr/bin/composer /usr/bin/composer

WORKDIR /var/www

# Copy composer files dan install dependencies
COPY composer.json ./
RUN composer install --no-dev --optimize-autoloader --no-scripts

# Copy seluruh source code Laravel
COPY . .

RUN composer dump-autoload --optimize

# ============================================
# Stage 2: Runtime container (PHP-FPM + Nginx + Supervisord)
# ============================================
FROM php:8.1-fpm-alpine AS runtime

ENV TZ=Asia/Jakarta \
    APP_ENV=production

# Install Nginx & Supervisord + PHP ext untuk Postgres
RUN apk add --no-cache \
    nginx supervisor icu-dev libzip-dev libpng-dev libxml2-dev \
    postgresql-dev sqlite && \
    docker-php-ext-install intl pdo_pgsql bcmath gd zip opcache && \
    rm -rf /var/cache/apk/*

WORKDIR /var/www

# Copy Laravel dari build stage
COPY --from=build /var/www /var/www

# Copy konfigurasi supervisord
COPY docker/supervisor/supervisord-websocket.conf /etc/supervisor/conf.d/supervisord.conf

# Set permission storage & bootstrap/cache
RUN chown -R www-data:www-data /var/www && \
    chmod -R 775 storage bootstrap/cache

EXPOSE 80

# Jalankan Nginx + PHP-FPM lewat supervisord
CMD ["supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
